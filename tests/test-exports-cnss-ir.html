<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tests Exports CNSS et IR</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .test-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #2c3e50;
      border-bottom: 3px solid #3498db;
      padding-bottom: 10px;
    }
    h2 {
      color: #34495e;
      margin-top: 0;
    }
    button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }
    button:hover {
      background-color: #2980b9;
    }
    button.success {
      background-color: #27ae60;
    }
    button.danger {
      background-color: #e74c3c;
    }
    .result {
      background-color: #ecf0f1;
      padding: 15px;
      border-radius: 4px;
      margin-top: 10px;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 400px;
      overflow-y: auto;
    }
    .success-message {
      color: #27ae60;
      font-weight: bold;
    }
    .error-message {
      color: #e74c3c;
      font-weight: bold;
    }
    .info {
      background-color: #d1ecf1;
      border-left: 4px solid #0c5460;
      padding: 10px;
      margin: 10px 0;
    }
    .warning {
      background-color: #fff3cd;
      border-left: 4px solid #856404;
      padding: 10px;
      margin: 10px 0;
    }
    input, select {
      padding: 8px;
      margin: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .form-group {
      margin: 10px 0;
    }
    label {
      display: inline-block;
      width: 150px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>ğŸ§ª Tests des Exports CNSS et IR</h1>

  <div class="info">
    <strong>Objectif:</strong> Tester la gÃ©nÃ©ration des fichiers Damancom (CNSS) et SIMPL-IR (DGI) conformes Ã  la rÃ©glementation marocaine.
  </div>

  <!-- Test 1: Export Damancom CNSS -->
  <div class="test-section">
    <h2>ğŸ“‹ Test 1: Export Damancom CNSS</h2>
    <p>GÃ©nÃ©ration d'un fichier texte tabulÃ© pour la tÃ©lÃ©transmission CNSS</p>

    <div class="form-group">
      <label>PÃ©riode:</label>
      <input type="month" id="cnss-periode" value="2025-01">
    </div>

    <div class="form-group">
      <label>Nombre d'employÃ©s:</label>
      <input type="number" id="cnss-nb-employes" value="5" min="1" max="100">
    </div>

    <button onclick="testExportDamancom()">ğŸš€ GÃ©nÃ©rer Fichier Damancom</button>
    <button onclick="verifierFormatDamancom()">âœ… VÃ©rifier Format</button>
    <button class="danger" onclick="testCasLimite()">âš ï¸ Tester Cas Limite</button>

    <div id="damancom-result" class="result" style="display:none;"></div>
  </div>

  <!-- Test 2: Export SIMPL-IR XML -->
  <div class="test-section">
    <h2>ğŸ“„ Test 2: Export SIMPL-IR (XML DGI)</h2>
    <p>GÃ©nÃ©ration d'un fichier XML pour la tÃ©lÃ©dÃ©claration IR Ã  la DGI</p>

    <div class="form-group">
      <label>PÃ©riode:</label>
      <input type="month" id="ir-periode" value="2025-01">
    </div>

    <div class="form-group">
      <label>Nombre d'employÃ©s:</label>
      <input type="number" id="ir-nb-employes" value="5" min="1" max="100">
    </div>

    <button onclick="testExportSIMPLIR()">ğŸš€ GÃ©nÃ©rer XML SIMPL-IR</button>
    <button onclick="verifierXMLValide()">âœ… Valider XML</button>
    <button onclick="downloadExamples()">ğŸ“¥ TÃ©lÃ©charger Exemples</button>

    <div id="ir-result" class="result" style="display:none;"></div>
  </div>

  <!-- Test 3: Validation des Calculs -->
  <div class="test-section">
    <h2>ğŸ§® Test 3: Validation des Calculs CNSS et IR</h2>
    <p>VÃ©rifier l'exactitude des calculs de cotisations sociales et d'impÃ´ts</p>

    <div class="form-group">
      <label>Salaire Brut (MAD):</label>
      <input type="number" id="salaire-test" value="8000" step="100">
    </div>

    <button onclick="testCalculsCNSS()">ğŸ§® Calculer Cotisations CNSS</button>
    <button onclick="testCalculsIR()">ğŸ§® Calculer IR</button>
    <button onclick="testBaremeComplet()">ğŸ“Š Tester BarÃ¨me Complet</button>

    <div id="calculs-result" class="result" style="display:none;"></div>
  </div>

  <!-- Test 4: Tests d'IntÃ©gration -->
  <div class="test-section">
    <h2>ğŸ”— Test 4: Test d'IntÃ©gration Complet</h2>
    <p>Tester le processus complet: paie â†’ dÃ©clarations â†’ exports</p>

    <button onclick="testFluxComplet()">ğŸ”„ Tester Flux Complet</button>
    <button onclick="testMultiplesPeriodes()">ğŸ“… Tester Plusieurs PÃ©riodes</button>
    <button class="success" onclick="executerTousLesTests()">âœ¨ ExÃ©cuter Tous les Tests</button>

    <div id="integration-result" class="result" style="display:none;"></div>
  </div>

  <script type="module">
    import { generateDamancomFile, generateSIMPLIRXML } from '../assets/js/services/moroccanCompliance.js';

    // DonnÃ©es de test
    const companyInfoTest = {
      nom: 'SOCIÃ‰TÃ‰ TEST SARL',
      ice: '002345678901234',
      identifiantFiscal: '12345678',
      cnss: '1234567',
      patente: '12345678',
      rc: '123456',
      adresse: '123 Avenue Mohammed V',
      ville: 'Casablanca',
      telephone: '+212 522 123456',
      directeur: 'M. Ahmed BENALI'
    };

    const employeesTest = [
      {
        id: 'emp1',
        matricule: 'E001',
        nom: 'ALAMI',
        prenom: 'Fatima',
        cnss: '123456789',
        cnie: 'AB123456',
        matriculeCNSS: '123456789',
        numeroImmatriculation: '123456789',
        salaireBase: 8000,
        poste: 'Comptable',
        dateEmbauche: '2020-01-15',
        departement: 'Finance'
      },
      {
        id: 'emp2',
        matricule: 'E002',
        nom: 'BENNANI',
        prenom: 'Mohammed',
        cnss: '987654321',
        cnie: 'CD789012',
        matriculeCNSS: '987654321',
        numeroImmatriculation: '987654321',
        salaireBase: 12000,
        poste: 'Chef de Projet',
        dateEmbauche: '2019-06-01',
        departement: 'IT'
      },
      {
        id: 'emp3',
        matricule: 'E003',
        nom: 'CHAKIR',
        prenom: 'Amina',
        cnss: '456789123',
        cnie: 'EF345678',
        matriculeCNSS: '456789123',
        numeroImmatriculation: '456789123',
        salaireBase: 5000,
        poste: 'Assistant RH',
        dateEmbauche: '2021-03-10',
        departement: 'RH'
      },
      {
        id: 'emp4',
        matricule: 'E004',
        nom: 'IDRISSI',
        prenom: 'Youssef',
        cnss: '789123456',
        cnie: 'GH901234',
        matriculeCNSS: '789123456',
        numeroImmatriculation: '789123456',
        salaireBase: 15000,
        poste: 'Directeur Commercial',
        dateEmbauche: '2018-01-01',
        departement: 'Commercial'
      },
      {
        id: 'emp5',
        matricule: 'E005',
        nom: 'ZIANI',
        prenom: 'Sanaa',
        cnss: '321654987',
        cnie: 'IJ567890',
        matriculeCNSS: '321654987',
        numeroImmatriculation: '321654987',
        salaireBase: 6500,
        poste: 'DÃ©veloppeur',
        dateEmbauche: '2022-09-01',
        departement: 'IT'
      }
    ];

    function createDeclarationCNSS(periode, nbEmployes) {
      const employees = employeesTest.slice(0, nbEmployes);
      const details = employees.map(emp => ({
        employeeId: emp.id,
        salaireBrut: emp.salaireBase,
        nombreJours: 26,
        cotisationsCNSS: Math.min(emp.salaireBase, 6000) * 0.0674
      }));

      return {
        id: `decl_cnss_${Date.now()}`,
        type: 'cnss',
        periode: periode,
        nbEmployes: employees.length,
        details: details,
        numeroDeclaration: `CNSS${periode.replace('-', '')}${Date.now()}`
      };
    }

    function createDeclarationIR(periode, nbEmployes) {
      const employees = employeesTest.slice(0, nbEmployes);
      const details = employees.map(emp => {
        const salaireBrut = emp.salaireBase;
        const cotisationsCNSS = Math.min(salaireBrut, 6000) * 0.0674;
        const salaireNet = salaireBrut - cotisationsCNSS;
        const salaireImposable = salaireNet;
        const montantIR = calculerIR(salaireImposable);

        return {
          employeeId: emp.id,
          salaireBrut: salaireBrut,
          cotisationsCNSS: cotisationsCNSS,
          autresDeductions: 0,
          salaireNet: salaireNet,
          salaireImposable: salaireImposable,
          montantIR: montantIR,
          nombreJours: 26
        };
      });

      return {
        id: `decl_ir_${Date.now()}`,
        type: 'ir',
        periode: periode,
        nbEmployes: employees.length,
        details: details,
        numeroDeclaration: `IR${periode.replace('-', '')}${Date.now()}`
      };
    }

    function calculerIR(salaireImposable) {
      // BarÃ¨me IR 2025 (annuel, donc multiplier par 12)
      const annuel = salaireImposable * 12;
      let ir = 0;

      if (annuel <= 30000) {
        ir = 0;
      } else if (annuel <= 50000) {
        ir = (annuel - 30000) * 0.10;
      } else if (annuel <= 60000) {
        ir = 2000 + (annuel - 50000) * 0.20;
      } else if (annuel <= 80000) {
        ir = 4000 + (annuel - 60000) * 0.30;
      } else if (annuel <= 180000) {
        ir = 10000 + (annuel - 80000) * 0.34;
      } else {
        ir = 44000 + (annuel - 180000) * 0.38;
      }

      return ir / 12; // Retour au mensuel
    }

    window.testExportDamancom = function() {
      try {
        const periode = document.getElementById('cnss-periode').value;
        const nbEmployes = parseInt(document.getElementById('cnss-nb-employes').value);

        const declaration = createDeclarationCNSS(periode, nbEmployes);
        const employees = employeesTest.slice(0, nbEmployes);

        const result = generateDamancomFile(declaration, employees, companyInfoTest);

        const resultDiv = document.getElementById('damancom-result');
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
<span class="success-message">âœ… Fichier Damancom gÃ©nÃ©rÃ© avec succÃ¨s!</span>

ğŸ“ Nom du fichier: ${result.filename}
ğŸ“Š Format: ${result.format}
ğŸ”¤ Encodage: ${result.encoding}

ğŸ“„ Contenu (aperÃ§u):
${result.content.split('\n').slice(0, 10).join('\n')}
...
Total ${result.content.split('\n').length} lignes

ğŸ“¥ Le fichier peut Ãªtre tÃ©lÃ©chargÃ© pour tÃ©lÃ©transmission CNSS
        `;

        // CrÃ©er un blob et tÃ©lÃ©charger
        const blob = new Blob([result.content], { type: result.format });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = result.filename;
        a.click();
        URL.revokeObjectURL(url);

      } catch (error) {
        document.getElementById('damancom-result').innerHTML =
          `<span class="error-message">âŒ Erreur: ${error.message}</span>`;
        document.getElementById('damancom-result').style.display = 'block';
      }
    };

    window.testExportSIMPLIR = function() {
      try {
        const periode = document.getElementById('ir-periode').value;
        const nbEmployes = parseInt(document.getElementById('ir-nb-employes').value);

        const declaration = createDeclarationIR(periode, nbEmployes);
        const employees = employeesTest.slice(0, nbEmployes);

        const result = generateSIMPLIRXML(declaration, employees, companyInfoTest);

        const resultDiv = document.getElementById('ir-result');
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
<span class="success-message">âœ… Fichier SIMPL-IR XML gÃ©nÃ©rÃ© avec succÃ¨s!</span>

ğŸ“ Nom du fichier: ${result.filename}
ğŸ“Š Format: ${result.format}
ğŸ”¤ Encodage: ${result.encoding}

ğŸ“„ Contenu XML (aperÃ§u):
${escapeHtml(result.content.split('\n').slice(0, 20).join('\n'))}
...

ğŸ“¥ Le fichier peut Ãªtre tÃ©lÃ©chargÃ© pour tÃ©lÃ©dÃ©claration DGI
        `;

        // TÃ©lÃ©charger le fichier
        const blob = new Blob([result.content], { type: result.format });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = result.filename;
        a.click();
        URL.revokeObjectURL(url);

      } catch (error) {
        document.getElementById('ir-result').innerHTML =
          `<span class="error-message">âŒ Erreur: ${error.message}</span>`;
        document.getElementById('ir-result').style.display = 'block';
      }
    };

    window.verifierFormatDamancom = function() {
      const declaration = createDeclarationCNSS('2025-01', 3);
      const result = generateDamancomFile(declaration, employeesTest.slice(0, 3), companyInfoTest);

      const lines = result.content.split('\n');
      const header = lines[0].split('\t');

      const checks = [
        { test: 'En-tÃªte prÃ©sent', pass: header.length === 12 },
        { test: 'Format tabulÃ©', pass: result.content.includes('\t') },
        { test: 'Encodage UTF-8', pass: result.encoding === 'UTF-8' },
        { test: 'Extension .txt', pass: result.filename.endsWith('.txt') },
        { test: 'Ligne totaux prÃ©sente', pass: lines[lines.length - 1].startsWith('TOTAL') }
      ];

      const resultDiv = document.getElementById('damancom-result');
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = `
<span class="success-message">ğŸ“‹ VÃ©rification du format Damancom:</span>

${checks.map(c => `${c.pass ? 'âœ…' : 'âŒ'} ${c.test}`).join('\n')}

${checks.every(c => c.pass) ?
  '<span class="success-message">âœ¨ Tous les tests de format sont passÃ©s!</span>' :
  '<span class="error-message">âš ï¸ Certains tests ont Ã©chouÃ©</span>'}
      `;
    };

    window.verifierXMLValide = function() {
      const declaration = createDeclarationIR('2025-01', 3);
      const result = generateSIMPLIRXML(declaration, employeesTest.slice(0, 3), companyInfoTest);

      try {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(result.content, 'application/xml');
        const parserError = xmlDoc.querySelector('parsererror');

        if (parserError) {
          throw new Error('XML invalide');
        }

        const checks = [
          { test: 'XML bien formÃ©', pass: !parserError },
          { test: 'DÃ©claration XML prÃ©sente', pass: result.content.startsWith('<?xml') },
          { test: 'Namespace correct', pass: result.content.includes('xmlns') },
          { test: 'Balise racine DeclarationIR', pass: result.content.includes('<DeclarationIR') },
          { test: 'Section EnTete prÃ©sente', pass: result.content.includes('<EnTete>') },
          { test: 'Section Declarant prÃ©sente', pass: result.content.includes('<Declarant>') },
          { test: 'Section Salaries prÃ©sente', pass: result.content.includes('<Salaries>') },
          { test: 'Section Recapitulatif prÃ©sente', pass: result.content.includes('<Recapitulatif>') }
        ];

        const resultDiv = document.getElementById('ir-result');
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
<span class="success-message">ğŸ“‹ Validation du XML SIMPL-IR:</span>

${checks.map(c => `${c.pass ? 'âœ…' : 'âŒ'} ${c.test}`).join('\n')}

${checks.every(c => c.pass) ?
  '<span class="success-message">âœ¨ Le XML est valide et conforme!</span>' :
  '<span class="error-message">âš ï¸ Le XML prÃ©sente des anomalies</span>'}
        `;

      } catch (error) {
        document.getElementById('ir-result').innerHTML =
          `<span class="error-message">âŒ Erreur de validation: ${error.message}</span>`;
        document.getElementById('ir-result').style.display = 'block';
      }
    };

    window.testCalculsCNSS = function() {
      const salaireBrut = parseFloat(document.getElementById('salaire-test').value);
      const salaireSoumis = Math.min(salaireBrut, 6000);

      const cotisations = {
        prestationsSocialesSalarie: salaireSoumis * 0.0448,
        amoSalarie: salaireBrut * 0.0226,
        totalSalarie: salaireSoumis * 0.0674,
        prestationsSocialesEmployeur: salaireSoumis * 0.064,
        allocationsFamiliales: salaireSoumis * 0.0898,
        amoEmployeur: salaireBrut * 0.0411,
        tfpEmployeur: salaireBrut * 0.016,
        totalEmployeur: salaireSoumis * 0.064 + salaireSoumis * 0.0898 + salaireBrut * 0.0411 + salaireBrut * 0.016
      };

      const resultDiv = document.getElementById('calculs-result');
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = `
<span class="success-message">ğŸ§® Calculs CNSS pour un salaire de ${salaireBrut.toFixed(2)} MAD:</span>

ğŸ’° Salaire brut: ${salaireBrut.toFixed(2)} MAD
ğŸ“Š Salaire soumis (plafonnÃ©): ${salaireSoumis.toFixed(2)} MAD

ğŸ‘¤ COTISATIONS SALARIÃ‰:
   â€¢ Prestations sociales (4.48%): ${cotisations.prestationsSocialesSalarie.toFixed(2)} MAD
   â€¢ AMO (2.26%): ${cotisations.amoSalarie.toFixed(2)} MAD
   â€¢ TOTAL SALARIÃ‰: ${cotisations.totalSalarie.toFixed(2)} MAD

ğŸ¢ COTISATIONS EMPLOYEUR:
   â€¢ Prestations sociales (6.4%): ${cotisations.prestationsSocialesEmployeur.toFixed(2)} MAD
   â€¢ Allocations familiales (8.98%): ${cotisations.allocationsFamiliales.toFixed(2)} MAD
   â€¢ AMO (4.11%): ${cotisations.amoEmployeur.toFixed(2)} MAD
   â€¢ TFP (1.6%): ${cotisations.tfpEmployeur.toFixed(2)} MAD
   â€¢ TOTAL EMPLOYEUR: ${cotisations.totalEmployeur.toFixed(2)} MAD

ğŸ’µ COÃ›T TOTAL: ${(salaireBrut + cotisations.totalEmployeur).toFixed(2)} MAD
      `;
    };

    window.testCalculsIR = function() {
      const salaireBrut = parseFloat(document.getElementById('salaire-test').value);
      const salaireSoumis = Math.min(salaireBrut, 6000);
      const cotisationsCNSS = salaireSoumis * 0.0674;
      const salaireNet = salaireBrut - cotisationsCNSS;
      const ir = calculerIR(salaireNet);
      const netApayer = salaireNet - ir;

      const resultDiv = document.getElementById('calculs-result');
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = `
<span class="success-message">ğŸ§® Calcul IR pour un salaire de ${salaireBrut.toFixed(2)} MAD:</span>

ğŸ’° Salaire brut: ${salaireBrut.toFixed(2)} MAD
â– Cotisations CNSS: ${cotisationsCNSS.toFixed(2)} MAD
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ’µ Salaire net (imposable): ${salaireNet.toFixed(2)} MAD
ğŸ“Š Salaire annuel imposable: ${(salaireNet * 12).toFixed(2)} MAD

ğŸ“‰ IR mensuel: ${ir.toFixed(2)} MAD
ğŸ“‰ IR annuel: ${(ir * 12).toFixed(2)} MAD
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… NET Ã€ PAYER: ${netApayer.toFixed(2)} MAD

ğŸ“Š Taux effectif d'imposition: ${((ir / salaireNet) * 100).toFixed(2)}%
      `;
    };

    window.testBaremeComplet = function() {
      const salaires = [3000, 5000, 8000, 10000, 15000, 20000, 30000];
      let results = '<span class="success-message">ğŸ“Š Test du barÃ¨me IR complet:</span>\n\n';

      results += 'Salaire Brut | IR Mensuel | Taux Effectif | Net Ã  Payer\n';
      results += 'â”'.repeat(60) + '\n';

      salaires.forEach(salaire => {
        const salaireSoumis = Math.min(salaire, 6000);
        const cotisationsCNSS = salaireSoumis * 0.0674;
        const salaireNet = salaire - cotisationsCNSS;
        const ir = calculerIR(salaireNet);
        const netApayer = salaireNet - ir;
        const tauxEffectif = (ir / salaireNet) * 100;

        results += `${salaire.toString().padEnd(12)} | ${ir.toFixed(2).padEnd(10)} | ${tauxEffectif.toFixed(2)}% | ${netApayer.toFixed(2)}\n`;
      });

      const resultDiv = document.getElementById('calculs-result');
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = results;
    };

    window.testCasLimite = function() {
      // Test avec salaires limites
      const casLimites = [
        { nom: 'Salaire minimum', salaire: 2000 },
        { nom: 'Plafond CNSS', salaire: 6000 },
        { nom: 'Juste au-dessus du plafond', salaire: 6001 },
        { nom: 'Salaire trÃ¨s Ã©levÃ©', salaire: 50000 }
      ];

      let results = '<span class="success-message">âš ï¸ Test des cas limites:</span>\n\n';

      casLimites.forEach(cas => {
        const declaration = createDeclarationCNSS('2025-01', 1);
        declaration.details[0].salaireBrut = cas.salaire;

        const result = generateDamancomFile(declaration, [{
          ...employeesTest[0],
          salaireBase: cas.salaire
        }], companyInfoTest);

        results += `\nğŸ“Œ ${cas.nom} (${cas.salaire} MAD):\n`;
        results += result.content.split('\n')[1] + '\n';
      });

      const resultDiv = document.getElementById('damancom-result');
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = results;
    };

    window.testFluxComplet = function() {
      try {
        const periode = '2025-01';
        const nbEmployes = 5;

        // 1. CrÃ©er dÃ©claration CNSS
        const declCNSS = createDeclarationCNSS(periode, nbEmployes);
        const fileCNSS = generateDamancomFile(declCNSS, employeesTest.slice(0, nbEmployes), companyInfoTest);

        // 2. CrÃ©er dÃ©claration IR
        const declIR = createDeclarationIR(periode, nbEmployes);
        const fileIR = generateSIMPLIRXML(declIR, employeesTest.slice(0, nbEmployes), companyInfoTest);

        // 3. VÃ©rifications
        const checks = [
          { step: '1. DÃ©claration CNSS crÃ©Ã©e', pass: !!declCNSS.id },
          { step: '2. Fichier Damancom gÃ©nÃ©rÃ©', pass: !!fileCNSS.content },
          { step: '3. DÃ©claration IR crÃ©Ã©e', pass: !!declIR.id },
          { step: '4. Fichier SIMPL-IR gÃ©nÃ©rÃ©', pass: !!fileIR.content },
          { step: '5. CohÃ©rence CNSS/IR', pass: declCNSS.nbEmployes === declIR.nbEmployes }
        ];

        const resultDiv = document.getElementById('integration-result');
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
<span class="success-message">ğŸ”„ Test du flux complet - PÃ©riode ${periode}:</span>

${checks.map(c => `${c.pass ? 'âœ…' : 'âŒ'} ${c.step}`).join('\n')}

ğŸ“Š RÃ©sumÃ©:
   â€¢ Nombre d'employÃ©s traitÃ©s: ${nbEmployes}
   â€¢ Fichier CNSS: ${fileCNSS.filename}
   â€¢ Fichier IR: ${fileIR.filename}
   â€¢ Masse salariale brute: ${declCNSS.details.reduce((sum, d) => sum + d.salaireBrut, 0).toFixed(2)} MAD
   â€¢ Total IR: ${declIR.details.reduce((sum, d) => sum + d.montantIR, 0).toFixed(2)} MAD

${checks.every(c => c.pass) ?
  '<span class="success-message">âœ¨ Flux complet validÃ© avec succÃ¨s!</span>' :
  '<span class="error-message">âš ï¸ Des erreurs ont Ã©tÃ© dÃ©tectÃ©es</span>'}
        `;

      } catch (error) {
        document.getElementById('integration-result').innerHTML =
          `<span class="error-message">âŒ Erreur: ${error.message}</span>`;
        document.getElementById('integration-result').style.display = 'block';
      }
    };

    window.testMultiplesPeriodes = function() {
      const periodes = ['2024-11', '2024-12', '2025-01'];
      let results = '<span class="success-message">ğŸ“… Test sur plusieurs pÃ©riodes:</span>\n\n';

      periodes.forEach(periode => {
        const declCNSS = createDeclarationCNSS(periode, 5);
        const declIR = createDeclarationIR(periode, 5);

        results += `\nğŸ“† PÃ©riode ${periode}:\n`;
        results += `   âœ… CNSS: ${declCNSS.details.reduce((sum, d) => sum + d.cotisationsCNSS, 0).toFixed(2)} MAD\n`;
        results += `   âœ… IR: ${declIR.details.reduce((sum, d) => sum + d.montantIR, 0).toFixed(2)} MAD\n`;
      });

      const resultDiv = document.getElementById('integration-result');
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = results;
    };

    window.executerTousLesTests = function() {
      const resultDiv = document.getElementById('integration-result');
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = '<span class="success-message">â³ ExÃ©cution de tous les tests...</span>';

      setTimeout(() => {
        testFluxComplet();
        setTimeout(() => {
          const current = resultDiv.innerHTML;
          resultDiv.innerHTML = current + '\n\n<span class="success-message">âœ¨ Tous les tests ont Ã©tÃ© exÃ©cutÃ©s!</span>';
        }, 500);
      }, 500);
    };

    window.downloadExamples = function() {
      // GÃ©nÃ©rer des fichiers exemples
      const declCNSS = createDeclarationCNSS('2025-01', 5);
      const fileCNSS = generateDamancomFile(declCNSS, employeesTest.slice(0, 5), companyInfoTest);

      const declIR = createDeclarationIR('2025-01', 5);
      const fileIR = generateSIMPLIRXML(declIR, employeesTest.slice(0, 5), companyInfoTest);

      // TÃ©lÃ©charger CNSS
      const blobCNSS = new Blob([fileCNSS.content], { type: fileCNSS.format });
      const urlCNSS = URL.createObjectURL(blobCNSS);
      const aCNSS = document.createElement('a');
      aCNSS.href = urlCNSS;
      aCNSS.download = 'exemple_' + fileCNSS.filename;
      aCNSS.click();
      URL.revokeObjectURL(urlCNSS);

      // TÃ©lÃ©charger IR
      setTimeout(() => {
        const blobIR = new Blob([fileIR.content], { type: fileIR.format });
        const urlIR = URL.createObjectURL(blobIR);
        const aIR = document.createElement('a');
        aIR.href = urlIR;
        aIR.download = 'exemple_' + fileIR.filename;
        aIR.click();
        URL.revokeObjectURL(urlIR);
      }, 500);

      document.getElementById('ir-result').style.display = 'block';
      document.getElementById('ir-result').innerHTML =
        '<span class="success-message">âœ… Fichiers exemples tÃ©lÃ©chargÃ©s!</span>';
    };

    function escapeHtml(text) {
      return text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }
  </script>
</body>
</html>
