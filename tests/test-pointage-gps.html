<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tests Pointage GPS</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .test-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #2c3e50;
      border-bottom: 3px solid #3498db;
      padding-bottom: 10px;
    }
    h2 {
      color: #34495e;
      margin-top: 0;
    }
    button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }
    button:hover {
      background-color: #2980b9;
    }
    button.success {
      background-color: #27ae60;
    }
    button.warning {
      background-color: #f39c12;
    }
    button.danger {
      background-color: #e74c3c;
    }
    .result {
      background-color: #ecf0f1;
      padding: 15px;
      border-radius: 4px;
      margin-top: 10px;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 400px;
      overflow-y: auto;
    }
    .success-message {
      color: #27ae60;
      font-weight: bold;
    }
    .error-message {
      color: #e74c3c;
      font-weight: bold;
    }
    .warning-message {
      color: #f39c12;
      font-weight: bold;
    }
    .info {
      background-color: #d1ecf1;
      border-left: 4px solid #0c5460;
      padding: 10px;
      margin: 10px 0;
    }
    .warning {
      background-color: #fff3cd;
      border-left: 4px solid #856404;
      padding: 10px;
      margin: 10px 0;
    }
    input, select {
      padding: 8px;
      margin: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 200px;
    }
    .form-group {
      margin: 10px 0;
    }
    label {
      display: inline-block;
      width: 150px;
      font-weight: bold;
    }
    .map-container {
      height: 400px;
      background-color: #e0e0e0;
      border-radius: 4px;
      margin: 10px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #3498db;
      color: white;
    }
    .location-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      margin: 2px;
    }
    .location-valid {
      background-color: #27ae60;
      color: white;
    }
    .location-invalid {
      background-color: #e74c3c;
      color: white;
    }
  </style>
</head>
<body>
  <h1>üìç Tests du Syst√®me de Pointage GPS</h1>

  <div class="info">
    <strong>Objectif:</strong> Tester le syst√®me de pointage avec g√©olocalisation GPS, validation de p√©rim√®tre, et d√©tection d'anomalies.
  </div>

  <!-- Test 1: Localisation GPS en temps r√©el -->
  <div class="test-section">
    <h2>üåç Test 1: G√©olocalisation en Temps R√©el</h2>
    <p>Tester la capture de position GPS et la validation du p√©rim√®tre</p>

    <button onclick="getCurrentGPS()">üì° Obtenir Ma Position GPS</button>
    <button onclick="testGPSPermissions()">üîí V√©rifier Permissions</button>
    <button onclick="simulateGPS()">üé≠ Simuler Position GPS</button>

    <div id="gps-result" class="result" style="display:none;"></div>
  </div>

  <!-- Test 2: Validation des Bureaux -->
  <div class="test-section">
    <h2>üè¢ Test 2: Configuration des Bureaux</h2>
    <p>Afficher et tester les localisations de bureaux configur√©es</p>

    <button onclick="showOfficeLocations()">üìç Afficher Bureaux</button>
    <button onclick="testAllOfficeLocations()">‚úÖ Tester Validations</button>
    <button onclick="calculateDistances()">üìè Calculer Distances</button>

    <div id="office-result" class="result" style="display:none;"></div>
  </div>

  <!-- Test 3: Pointage Check-In -->
  <div class="test-section">
    <h2>üîµ Test 3: Pointage d'Entr√©e (Check-In)</h2>
    <p>Simuler un pointage d'entr√©e avec diff√©rents sc√©narios</p>

    <div class="form-group">
      <label>Latitude:</label>
      <input type="number" id="checkin-lat" value="33.5731" step="0.0001">
    </div>

    <div class="form-group">
      <label>Longitude:</label>
      <input type="number" id="checkin-lng" value="-7.5898" step="0.0001">
    </div>

    <div class="form-group">
      <label>Heure:</label>
      <input type="time" id="checkin-time" value="08:30">
    </div>

    <button onclick="testCheckIn(false)">‚úÖ Check-In Normal</button>
    <button class="warning" onclick="testCheckIn(true)">‚è∞ Check-In en Retard</button>
    <button class="danger" onclick="testCheckInOutOfRange()">üö´ Hors P√©rim√®tre</button>

    <div id="checkin-result" class="result" style="display:none;"></div>
  </div>

  <!-- Test 4: Pointage Check-Out -->
  <div class="test-section">
    <h2>üî¥ Test 4: Pointage de Sortie (Check-Out)</h2>
    <p>Simuler un pointage de sortie avec calcul d'heures</p>

    <div class="form-group">
      <label>Heure:</label>
      <input type="time" id="checkout-time" value="17:30">
    </div>

    <button onclick="testCheckOut(false)">‚úÖ Check-Out Normal</button>
    <button class="warning" onclick="testCheckOut(true)">‚è∞ D√©part Anticip√©</button>
    <button class="success" onclick="testCheckOutOvertime()">üí™ Heures Suppl√©mentaires</button>

    <div id="checkout-result" class="result" style="display:none;"></div>
  </div>

  <!-- Test 5: D√©tection d'Anomalies -->
  <div class="test-section">
    <h2>‚ö†Ô∏è Test 5: D√©tection d'Anomalies</h2>
    <p>Tester la d√©tection automatique des anomalies de pointage</p>

    <button onclick="testRetards()">‚è∞ Tester Retards</button>
    <button onclick="testDepartsAnticipes()">üèÉ Tester D√©parts Anticip√©s</button>
    <button onclick="testGPSAnomalies()">üìç Tester Anomalies GPS</button>
    <button class="danger" onclick="testAllAnomalies()">üî• Tout Tester</button>

    <div id="anomalies-result" class="result" style="display:none;"></div>
  </div>

  <!-- Test 6: Statistiques -->
  <div class="test-section">
    <h2>üìä Test 6: Calcul de Statistiques</h2>
    <p>Tester le calcul des statistiques de pointage sur une p√©riode</p>

    <div class="form-group">
      <label>Date d√©but:</label>
      <input type="date" id="stats-start" value="2025-01-01">
    </div>

    <div class="form-group">
      <label>Date fin:</label>
      <input type="date" id="stats-end" value="2025-01-31">
    </div>

    <button onclick="calculateTimeStats()">üìä Calculer Statistiques</button>
    <button onclick="generateReport()">üìÑ G√©n√©rer Rapport</button>
    <button class="success" onclick="runFullTest()">üöÄ Test Complet</button>

    <div id="stats-result" class="result" style="display:none;"></div>
  </div>

  <script type="module">
    import {
      timeTrackingConfig,
      validateGPSLocation,
      checkIn,
      checkOut,
      calculateTimeStats,
      getCurrentLocation
    } from '../assets/js/services/advancedTimeTracking.js';

    // Exposer les fonctions globalement
    window.timeTrackingConfig = timeTrackingConfig;
    window.validateGPSLocation = validateGPSLocation;
    window.checkIn = checkIn;
    window.checkOut = checkOut;
    window.calculateTimeStats = calculateTimeStats;
    window.getCurrentLocation = getCurrentLocation;

    // Variables globales pour les tests
    let currentCheckInId = null;
    let testAttendanceRecords = [];

    window.getCurrentGPS = async function() {
      const resultDiv = document.getElementById('gps-result');
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = '<span class="warning-message">üì° Demande de g√©olocalisation en cours...</span>';

      try {
        const position = await getCurrentLocation();

        const validation = validateGPSLocation(position.latitude, position.longitude);

        resultDiv.innerHTML = `
<span class="success-message">‚úÖ Position GPS obtenue avec succ√®s!</span>

üìç Coordonn√©es:
   ‚Ä¢ Latitude: ${position.latitude.toFixed(6)}
   ‚Ä¢ Longitude: ${position.longitude.toFixed(6)}
   ‚Ä¢ Pr√©cision: ${position.accuracy.toFixed(2)} m√®tres
   ‚Ä¢ Altitude: ${position.altitude ? position.altitude.toFixed(2) + ' m' : 'Non disponible'}
   ‚Ä¢ Timestamp: ${position.timestamp}

${validation.valid ?
  `<span class="success-message">‚úÖ Position VALIDE - ${validation.location}</span>
   üìè Distance du bureau: ${validation.distance} m√®tres` :
  `<span class="error-message">‚ùå Position INVALIDE</span>
   ‚ö†Ô∏è ${validation.message}
   üìè Distance du bureau le plus proche (${validation.closestLocation}): ${validation.distance} m√®tres`}
        `;

      } catch (error) {
        resultDiv.innerHTML = `<span class="error-message">‚ùå Erreur: ${error.message}</span>

üí° Astuces:
   ‚Ä¢ V√©rifiez que la g√©olocalisation est activ√©e dans votre navigateur
   ‚Ä¢ Autorisez l'acc√®s √† votre position quand demand√©
   ‚Ä¢ V√©rifiez que vous √™tes en HTTPS (requis pour la g√©olocalisation)
        `;
      }
    };

    window.testGPSPermissions = async function() {
      const resultDiv = document.getElementById('gps-result');
      resultDiv.style.display = 'block';

      const checks = [
        { test: 'Navigateur supporte la g√©olocalisation', pass: !!navigator.geolocation },
        { test: 'Connexion s√©curis√©e (HTTPS)', pass: window.location.protocol === 'https:' || window.location.hostname === 'localhost' },
        { test: 'API Permissions disponible', pass: !!navigator.permissions }
      ];

      let permissionStatus = 'Non test√©';
      if (navigator.permissions) {
        try {
          const result = await navigator.permissions.query({ name: 'geolocation' });
          permissionStatus = result.state;
          checks.push({ test: 'Permission g√©olocalisation', pass: result.state === 'granted' });
        } catch (e) {
          checks.push({ test: 'Permission g√©olocalisation', pass: false });
        }
      }

      resultDiv.innerHTML = `
<span class="success-message">üîí V√©rification des permissions GPS:</span>

${checks.map(c => `${c.pass ? '‚úÖ' : '‚ùå'} ${c.test}`).join('\n')}

üìä √âtat de la permission: ${permissionStatus}

${checks.every(c => c.pass) ?
  '<span class="success-message">‚ú® Toutes les v√©rifications sont pass√©es!</span>' :
  `<span class="warning-message">‚ö†Ô∏è Certaines v√©rifications ont √©chou√©

üí° Si la g√©olocalisation ne fonctionne pas:
   ‚Ä¢ Utilisez HTTPS ou localhost
   ‚Ä¢ Autorisez la g√©olocalisation dans les param√®tres du navigateur
   ‚Ä¢ V√©rifiez les param√®tres de localisation de votre appareil</span>`}
      `;
    };

    window.simulateGPS = function() {
      const offices = timeTrackingConfig.gps.officeLocations;
      const selectedOffice = offices[0]; // Casablanca par d√©faut

      document.getElementById('checkin-lat').value = selectedOffice.lat;
      document.getElementById('checkin-lng').value = selectedOffice.lng;

      const resultDiv = document.getElementById('gps-result');
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = `
<span class="success-message">üé≠ Position GPS simul√©e!</span>

üìç Bureau s√©lectionn√©: ${selectedOffice.name}
   ‚Ä¢ Latitude: ${selectedOffice.lat}
   ‚Ä¢ Longitude: ${selectedOffice.lng}
   ‚Ä¢ Rayon autoris√©: ${selectedOffice.radius} m√®tres

‚úÖ Les coordonn√©es ont √©t√© remplies dans le formulaire de check-in
      `;
    };

    window.showOfficeLocations = function() {
      const offices = timeTrackingConfig.gps.officeLocations;

      let output = '<span class="success-message">üè¢ Bureaux configur√©s:</span>\n\n';
      output += '<table>\n';
      output += '<tr><th>Nom</th><th>Latitude</th><th>Longitude</th><th>Rayon (m)</th></tr>\n';

      offices.forEach(office => {
        output += `<tr>
          <td>${office.name}</td>
          <td>${office.lat}</td>
          <td>${office.lng}</td>
          <td>${office.radius}</td>
        </tr>\n`;
      });

      output += '</table>\n';

      const resultDiv = document.getElementById('office-result');
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = output;
    };

    window.testAllOfficeLocations = function() {
      const offices = timeTrackingConfig.gps.officeLocations;
      let output = '<span class="success-message">‚úÖ Test de validation pour chaque bureau:</span>\n\n';

      offices.forEach(office => {
        // Test au centre
        const validCenter = validateGPSLocation(office.lat, office.lng, offices);

        // Test √† 50m (devrait passer)
        const lat50 = office.lat + (50 / 111320); // Approximation
        const validNear = validateGPSLocation(lat50, office.lng, offices);

        // Test √† 200m (devrait √©chouer)
        const lat200 = office.lat + (200 / 111320);
        const invalidFar = validateGPSLocation(lat200, office.lng, offices);

        output += `\nüìç ${office.name}:\n`;
        output += `   ${validCenter.valid ? '‚úÖ' : '‚ùå'} Centre (0m): ${validCenter.message}\n`;
        output += `   ${validNear.valid ? '‚úÖ' : '‚ùå'} Proche (50m): ${validNear.message}\n`;
        output += `   ${!invalidFar.valid ? '‚úÖ' : '‚ùå'} Loin (200m): ${invalidFar.message}\n`;
      });

      const resultDiv = document.getElementById('office-result');
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = output;
    };

    window.calculateDistances = function() {
      const offices = timeTrackingConfig.gps.officeLocations;
      let output = '<span class="success-message">üìè Distances entre les bureaux:</span>\n\n';

      for (let i = 0; i < offices.length; i++) {
        for (let j = i + 1; j < offices.length; j++) {
          const validation = validateGPSLocation(
            offices[i].lat,
            offices[i].lng,
            [offices[j]]
          );

          output += `üìå ${offices[i].name} ‚Üî ${offices[j].name}: ${validation.distance} m√®tres\n`;
        }
      }

      const resultDiv = document.getElementById('office-result');
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = output;
    };

    window.testCheckIn = async function(isLate) {
      const lat = parseFloat(document.getElementById('checkin-lat').value);
      const lng = parseFloat(document.getElementById('checkin-lng').value);
      const timeStr = document.getElementById('checkin-time').value;

      // Cr√©er une date avec l'heure sp√©cifi√©e
      const now = new Date();
      const [hours, minutes] = timeStr.split(':');
      const checkInTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), parseInt(hours), parseInt(minutes));

      // Si test de retard, ajouter du d√©lai
      if (isLate) {
        checkInTime.setMinutes(checkInTime.getMinutes() + 45); // 45 min de retard
      }

      try {
        // Simuler le check-in
        const result = await checkIn('emp_test_001', {
          gps: {
            latitude: lat,
            longitude: lng,
            accuracy: 10,
            altitude: null
          },
          device: {
            type: 'web',
            model: 'Test Device'
          }
        });

        // Modifier le timestamp pour notre test
        result.timestamp = checkInTime.toISOString();
        result.time = checkInTime.toTimeString().split(' ')[0];

        currentCheckInId = result.id;
        testAttendanceRecords.push(result);

        const hasErrors = result.anomalies.filter(a => a.severity === 'error').length > 0;
        const hasWarnings = result.anomalies.filter(a => a.severity === 'warning').length > 0;

        const resultDiv = document.getElementById('checkin-result');
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
<span class="${hasErrors ? 'error-message' : 'success-message'}">
${hasErrors ? '‚ùå' : '‚úÖ'} Check-In ${result.validated ? 'VALID√â' : 'NON VALID√â'}
</span>

üìã D√©tails du pointage:
   ‚Ä¢ ID: ${result.id}
   ‚Ä¢ Employ√©: ${result.employeeId}
   ‚Ä¢ Date: ${result.date}
   ‚Ä¢ Heure: ${result.time}
   ‚Ä¢ Type: ${result.type}

üìç G√©olocalisation:
   ‚Ä¢ Latitude: ${result.gps.latitude}
   ‚Ä¢ Longitude: ${result.gps.longitude}
   ‚Ä¢ Pr√©cision: ${result.gps.accuracy} m
   ‚Ä¢ Valid√© GPS: ${result.gps.validated ? '‚úÖ' : '‚ùå'}
   ‚Ä¢ Localisation: ${result.gps.location || 'Non valid√©e'}

‚ö†Ô∏è Anomalies d√©tect√©es: ${result.anomalies.length}
${result.anomalies.map(a => `   ${a.severity === 'error' ? '‚ùå' : a.severity === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'} [${a.type}] ${a.message}`).join('\n')}

${result.validated ?
  '<span class="success-message">‚úÖ Pointage pr√™t √† √™tre enregistr√©</span>' :
  '<span class="warning-message">‚ö†Ô∏è Pointage n√©cessite une validation manuelle</span>'}
        `;

      } catch (error) {
        document.getElementById('checkin-result').innerHTML =
          `<span class="error-message">‚ùå Erreur: ${error.message}</span>`;
        document.getElementById('checkin-result').style.display = 'block';
      }
    };

    window.testCheckInOutOfRange = async function() {
      // Coordonn√©es hors de tout bureau (exemple: en pleine mer)
      const lat = 35.0;
      const lng = -8.0;

      document.getElementById('checkin-lat').value = lat;
      document.getElementById('checkin-lng').value = lng;

      await testCheckIn(false);
    };

    window.testCheckOut = async function(isEarly) {
      if (!currentCheckInId) {
        const resultDiv = document.getElementById('checkout-result');
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = '<span class="error-message">‚ùå Vous devez d\'abord faire un check-in!</span>';
        return;
      }

      const timeStr = document.getElementById('checkout-time').value;
      const now = new Date();
      const [hours, minutes] = timeStr.split(':');
      const checkOutTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), parseInt(hours), parseInt(minutes));

      if (isEarly) {
        checkOutTime.setHours(15, 30); // D√©part √† 15h30 (anticip√©)
      }

      try {
        const result = await checkOut('emp_test_001', currentCheckInId, {
          gps: {
            latitude: 33.5731,
            longitude: -7.5898,
            accuracy: 10
          },
          device: {
            type: 'web'
          }
        });

        result.timestamp = checkOutTime.toISOString();
        result.time = checkOutTime.toTimeString().split(' ')[0];

        testAttendanceRecords.push(result);

        // Calculer les heures travaill√©es
        const checkInRecord = testAttendanceRecords.find(r => r.id === currentCheckInId);
        const hoursWorked = (checkOutTime - new Date(checkInRecord.timestamp)) / (1000 * 60 * 60);

        const resultDiv = document.getElementById('checkout-result');
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
<span class="${result.validated ? 'success-message' : 'warning-message'}">
${result.validated ? '‚úÖ' : '‚ö†Ô∏è'} Check-Out ${result.validated ? 'VALID√â' : 'NON VALID√â'}
</span>

üìã D√©tails du pointage:
   ‚Ä¢ ID: ${result.id}
   ‚Ä¢ Check-In ID: ${result.checkInId}
   ‚Ä¢ Date: ${result.date}
   ‚Ä¢ Heure: ${result.time}

‚è±Ô∏è Temps de travail:
   ‚Ä¢ Heures travaill√©es: ${hoursWorked.toFixed(2)} heures
   ‚Ä¢ Heure d'arriv√©e: ${checkInRecord.time}
   ‚Ä¢ Heure de d√©part: ${result.time}

üìç G√©olocalisation:
   ‚Ä¢ Valid√© GPS: ${result.gps.validated ? '‚úÖ' : '‚ùå'}

‚ö†Ô∏è Anomalies d√©tect√©es: ${result.anomalies.length}
${result.anomalies.map(a => `   ${a.severity === 'error' ? '‚ùå' : a.severity === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'} [${a.type}] ${a.message}`).join('\n')}
        `;

      } catch (error) {
        document.getElementById('checkout-result').innerHTML =
          `<span class="error-message">‚ùå Erreur: ${error.message}</span>`;
        document.getElementById('checkout-result').style.display = 'block';
      }
    };

    window.testCheckOutOvertime = async function() {
      if (!currentCheckInId) {
        const resultDiv = document.getElementById('checkout-result');
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = '<span class="error-message">‚ùå Vous devez d\'abord faire un check-in!</span>';
        return;
      }

      document.getElementById('checkout-time').value = '19:30'; // Heures sup
      await testCheckOut(false);
    };

    window.testRetards = async function() {
      const retards = [5, 20, 45, 90]; // minutes de retard
      let output = '<span class="success-message">‚è∞ Test des retards:</span>\n\n';

      for (const retard of retards) {
        const checkInTime = new Date();
        checkInTime.setHours(8, 0 + retard, 0); // 8h00 + retard

        const result = await checkIn('emp_test', {
          gps: { latitude: 33.5731, longitude: -7.5898, accuracy: 10 }
        });

        result.timestamp = checkInTime.toISOString();
        result.time = checkInTime.toTimeString().split(' ')[0];

        const lateAnomaly = result.anomalies.find(a => a.type === 'LATE_ARRIVAL');

        output += `\n‚è∞ Arriv√©e √† ${result.time} (${retard} min de retard):\n`;
        output += `   ${lateAnomaly ? '‚ö†Ô∏è Retard d√©tect√©: ' + lateAnomaly.message : '‚úÖ Pas de retard'}\n`;
        output += `   S√©v√©rit√©: ${lateAnomaly ? lateAnomaly.severity : 'N/A'}\n`;
      }

      const resultDiv = document.getElementById('anomalies-result');
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = output;
    };

    window.testDepartsAnticipes = async function() {
      const heuresDepart = ['15:00', '16:00', '16:45', '17:10'];
      let output = '<span class="success-message">üèÉ Test des d√©parts anticip√©s:</span>\n\n';

      for (const heure of heuresDepart) {
        const checkOutTime = new Date();
        const [h, m] = heure.split(':');
        checkOutTime.setHours(parseInt(h), parseInt(m), 0);

        const result = await checkOut('emp_test', 'checkin_123', {
          gps: { latitude: 33.5731, longitude: -7.5898, accuracy: 10 }
        });

        result.timestamp = checkOutTime.toISOString();
        result.time = checkOutTime.toTimeString().split(' ')[0];

        const earlyAnomaly = result.anomalies.find(a => a.type === 'EARLY_DEPARTURE');

        output += `\nüïê D√©part √† ${result.time}:\n`;
        output += `   ${earlyAnomaly ? '‚ö†Ô∏è D√©part anticip√©: ' + earlyAnomaly.message : '‚úÖ Horaire normal'}\n`;
      }

      const resultDiv = document.getElementById('anomalies-result');
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = output;
    };

    window.testGPSAnomalies = async function() {
      const positions = [
        { name: 'Au bureau (Casablanca)', lat: 33.5731, lng: -7.5898, shouldPass: true },
        { name: '√Ä 50m du bureau', lat: 33.5736, lng: -7.5898, shouldPass: true },
        { name: '√Ä 150m du bureau', lat: 33.5745, lng: -7.5898, shouldPass: false },
        { name: 'Hors zone', lat: 35.0, lng: -8.0, shouldPass: false }
      ];

      let output = '<span class="success-message">üìç Test des anomalies GPS:</span>\n\n';

      for (const pos of positions) {
        const result = await checkIn('emp_test', {
          gps: { latitude: pos.lat, longitude: pos.lng, accuracy: 10 }
        });

        const gpsAnomaly = result.anomalies.find(a => a.type === 'GPS_OUT_OF_RANGE');

        output += `\nüìå ${pos.name}:\n`;
        output += `   GPS valid√©: ${result.gps.validated ? '‚úÖ' : '‚ùå'}\n`;
        output += `   ${gpsAnomaly ? '‚ö†Ô∏è ' + gpsAnomaly.message : '‚úÖ Position valide'}\n`;
        output += `   Test r√©ussi: ${pos.shouldPass === !gpsAnomaly ? '‚úÖ' : '‚ùå'}\n`;
      }

      const resultDiv = document.getElementById('anomalies-result');
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = output;
    };

    window.testAllAnomalies = async function() {
      const resultDiv = document.getElementById('anomalies-result');
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = '<span class="warning-message">üî• Ex√©cution de tous les tests d\'anomalies...</span>';

      await testRetards();
      await new Promise(resolve => setTimeout(resolve, 500));

      const current = resultDiv.innerHTML;
      await testDepartsAnticipes();
      await new Promise(resolve => setTimeout(resolve, 500));

      await testGPSAnomalies();
    };

    window.calculateTimeStats = function() {
      // G√©n√©rer des donn√©es de test pour un mois
      const startDate = new Date(document.getElementById('stats-start').value);
      const endDate = new Date(document.getElementById('stats-end').value);

      // Cr√©er des enregistrements factices
      const records = [];
      for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        // Sauter les weekends
        if (d.getDay() === 0 || d.getDay() === 6) continue;

        const dateStr = d.toISOString().split('T')[0];

        // Check-in (avec parfois du retard)
        const checkInTime = new Date(d);
        checkInTime.setHours(8, Math.random() < 0.3 ? 5 + Math.floor(Math.random() * 40) : 0);

        records.push({
          id: `ci_${dateStr}`,
          employeeId: 'emp_test',
          type: 'CHECK_IN',
          date: dateStr,
          timestamp: checkInTime.toISOString(),
          anomalies: checkInTime.getHours() >= 8 && checkInTime.getMinutes() > 15 ?
            [{ type: 'LATE_ARRIVAL', severity: 'warning', minutes: checkInTime.getMinutes() }] : []
        });

        // Check-out
        const checkOutTime = new Date(d);
        checkOutTime.setHours(17, Math.random() < 0.2 ? 30 + Math.floor(Math.random() * 120) : 0);

        records.push({
          id: `co_${dateStr}`,
          employeeId: 'emp_test',
          type: 'CHECK_OUT',
          date: dateStr,
          timestamp: checkOutTime.toISOString(),
          anomalies: checkOutTime.getHours() >= 18 ?
            [{ type: 'OVERTIME', severity: 'info', minutes: (checkOutTime.getHours() - 17) * 60 + checkOutTime.getMinutes() }] : []
        });
      }

      const stats = calculateTimeStats(records, startDate, endDate);

      const resultDiv = document.getElementById('stats-result');
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = `
<span class="success-message">üìä Statistiques de pointage:</span>

üìÖ P√©riode: ${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}

üìà Pr√©sence:
   ‚Ä¢ Jours ouvrables: ${stats.totalDays}
   ‚Ä¢ Jours pr√©sents: ${stats.presentDays}
   ‚Ä¢ Jours absents: ${stats.absentDays}
   ‚Ä¢ Taux de pr√©sence: ${((stats.presentDays / stats.totalDays) * 100).toFixed(1)}%

‚è∞ Ponctualit√©:
   ‚Ä¢ Jours en retard: ${stats.lateDays}
   ‚Ä¢ D√©parts anticip√©s: ${stats.earlyDepartures}
   ‚Ä¢ Taux de ponctualit√©: ${(((stats.presentDays - stats.lateDays) / stats.presentDays) * 100).toFixed(1)}%

üíº Heures de travail:
   ‚Ä¢ Total heures travaill√©es: ${stats.totalHoursWorked.toFixed(1)} heures
   ‚Ä¢ Moyenne par jour: ${stats.averageHoursPerDay ? stats.averageHoursPerDay.toFixed(2) : '0'} heures
   ‚Ä¢ Heures suppl√©mentaires: ${(stats.totalOvertimeMinutes / 60).toFixed(1)} heures

‚ö†Ô∏è Anomalies:
   ‚Ä¢ Total anomalies: ${stats.anomalies.total}
   ‚Ä¢ Par type: ${Object.entries(stats.anomalies.byType).map(([type, count]) => `\n      ${type}: ${count}`).join('')}
      `;
    };

    window.generateReport = function() {
      calculateTimeStats();

      const resultDiv = document.getElementById('stats-result');
      const content = resultDiv.innerHTML;

      resultDiv.innerHTML = content + `

<span class="success-message">üìÑ Rapport g√©n√©r√©!</span>

üí° Actions sugg√©r√©es:
   ${testAttendanceRecords.filter(r => r.anomalies.some(a => a.type === 'LATE_ARRIVAL')).length > 5 ?
     '‚ö†Ô∏è Nombre √©lev√© de retards - Consid√©rer un rappel des horaires' :
     '‚úÖ Ponctualit√© satisfaisante'}

   ${testAttendanceRecords.filter(r => r.anomalies.some(a => a.type === 'GPS_OUT_OF_RANGE')).length > 0 ?
     'üìç Anomalies GPS d√©tect√©es - V√©rifier les p√©rim√®tres configur√©s' :
     '‚úÖ Tous les pointages GPS sont conformes'}
      `;
    };

    window.runFullTest = async function() {
      const resultDiv = document.getElementById('stats-result');
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = '<span class="success-message">üöÄ Ex√©cution du test complet...</span>\n\n';

      const tests = [
        { name: 'V√©rification permissions GPS', fn: () => testGPSPermissions() },
        { name: 'Affichage des bureaux', fn: () => showOfficeLocations() },
        { name: 'Test check-in normal', fn: () => testCheckIn(false) },
        { name: 'Test check-out normal', fn: () => testCheckOut(false) },
        { name: 'Test anomalies', fn: () => testAllAnomalies() },
        { name: 'Calcul statistiques', fn: () => calculateTimeStats() }
      ];

      for (const test of tests) {
        try {
          await test.fn();
          resultDiv.innerHTML += `‚úÖ ${test.name}\n`;
        } catch (error) {
          resultDiv.innerHTML += `‚ùå ${test.name}: ${error.message}\n`;
        }
        await new Promise(resolve => setTimeout(resolve, 300));
      }

      resultDiv.innerHTML += '\n<span class="success-message">‚ú® Test complet termin√©!</span>';
    };
  </script>
</body>
</html>
